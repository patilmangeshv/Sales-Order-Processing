<ion-header>
    <ion-toolbar>
        <ion-buttons slot="start">
            <ion-menu-button></ion-menu-button>
        </ion-buttons>

        <ion-title>
            Sales orders [{{recordCount | number:'1.0-2'}}]
        </ion-title>
    </ion-toolbar>
</ion-header>

<ion-content>
    <app-dealer-name-strip #dealerNameStrip [(isDataLoaded)]="commonData.dealer" (dealerChanged)="dealerChanged()">
    </app-dealer-name-strip>

    <ion-row>
        <slot></slot>
        <slot></slot>
        <ion-col size="7">
            <ion-searchbar color="light" animated autocomplete="on" placeholder="Search by name or mobile number"
                (ionInput)="filterDataOnSearchText($event)">
            </ion-searchbar>
        </ion-col>

        <ion-col size="5" class="alignFilter">
            <ion-item class="toggle-item">
                Exported?<ion-toggle color="secondary" [(ngModel)]="includeExport" (ionChange)="includeExportChanged()">
                </ion-toggle>
            </ion-item>

            <!-- <ion-button color="light">
                <ion-icon name="filter-outline" color="secondary"></ion-icon>
                <ion-icon name="filter" color="secondary"></ion-icon>
            </ion-button> -->
        </ion-col>
    </ion-row>

    <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
        <ion-refresher-content pullingIcon="arrow-down" pullingText="Pull to refresh" refreshingSpinner="circles"
            refreshingText="Refreshing...">
        </ion-refresher-content>
    </ion-refresher>

    <div *ngIf="commonData.dealer">
        <ion-item-group *ngFor="let status of orderStatusInfo">
            <ion-item-divider [class]="status.color">

                <!-- up/down arrow to hide/show orders -->
                <ion-icon *ngIf="status.showOrders" slot="start" name="chevron-down-outline"
                    (click)="showHideOrders(status)"></ion-icon>
                <ion-icon *ngIf="!status.showOrders" slot="start" name="chevron-up-outline"
                    (click)="showHideOrders(status)"></ion-icon>

                <!-- order status lable and count -->
                <ion-label (click)="showHideOrders(status)">{{status.text}} -
                    [{{status.selectedOrdersCount | number:'1.0-2'}}/{{status.orderStatusCount | number:'1.0-2'}}]
                </ion-label>

                <!-- delete button to delete orders -->
                <ion-button *ngIf="showDeleteButton(status)" [disabled]="status.selectedOrdersCount<=0" slot="end"
                    color="transperant" (click)="deleteOrdersConfirm(status)">
                    <ion-icon name="trash" slot="icon-only" color="secondary">
                    </ion-icon>
                </ion-button>
                <!-- export button to export data -->
                <ion-button *ngIf="showExportDataButton(status)" [disabled]="status.selectedOrdersCount<=0" slot="end"
                    color="transperant" (click)="exportOrdersConfirm(status)">
                    <ion-icon name="cloud-download-outline" slot="icon-only" color="secondary">
                    </ion-icon>
                </ion-button>

                <!-- <ion-icon *ngIf="status.showOrders" slot="start" name="chevron-down-outline"></ion-icon>
                <ion-icon *ngIf="!status.showOrders" slot="start" name="chevron-up-outline"></ion-icon>
                <ion-label>{{status.text}} - [{{status.orderStatusCount | number:'1.0-2'}}]</ion-label>
                <ion-icon name="cloud-download-outline" slot="end" color="secondary"></ion-icon> -->
            </ion-item-divider>

            <ng-container *ngIf="salesOrderList?.keys">
                <ng-container *ngFor="let order of salesOrderList">
                    <ng-container *ngIf="order.orderStatus == status.orderStatus">
                        <ion-card color="light" *ngIf="status.showOrders">
                            <!-- Click will be individual as we don't want to get that for orderStatus change -->
                            <ion-card-header>
                                <ion-item>
                                    <ion-card-title class="ion-text-wrap" (click)="viewOrderDetails(order)">
                                        {{order.customerDetails.customerName}}
                                    </ion-card-title>

                                    <!-- Show select icon tick if user has selected it. -->
                                    <ion-icon name="checkmark-circle-outline"
                                        *ngIf="order.isSalesOrderSelected"
                                        (click)="orderSelected(order, status)" color="secondary" slot="end">
                                    </ion-icon>
                                    <ion-icon name="ellipse-outline"
                                        *ngIf="!order.isSalesOrderSelected"
                                        (click)="orderSelected(order, status)" color="secondary" slot="end">
                                    </ion-icon>
                                </ion-item>

                                <ion-card-subtitle (click)="viewOrderDetails(order)">
                                    Mobile:{{order.customerDetails.mobileNo}}
                                    Pin:{{order.customerDetails.pincode}}
                                </ion-card-subtitle>
                            </ion-card-header>

                            <ion-card-content>
                                <ion-row (click)="viewOrderDetails(order)">
                                    <ion-col>
                                        Order no.: <ion-text color="secondary">
                                            {{order.salesOrderNo}}</ion-text>
                                    </ion-col>
                                    <ion-col>
                                        date: <ion-text color="secondary">
                                            {{order.orderDate | date:'EE dd MMM yyyy'}}</ion-text>
                                    </ion-col>
                                </ion-row>

                                <ion-row (click)="viewOrderDetails(order)">
                                    <ion-col size="6">
                                        Amount: <ion-text color="secondary">
                                            {{order.totalAmt | number:'1.2-2'}}
                                        </ion-text>
                                    </ion-col>
                                    <ion-col size="6">
                                        Qty: <ion-text color="secondary">
                                            {{order.totalQty | number:'1.0-2'}}
                                        </ion-text>
                                    </ion-col>
                                </ion-row>

                                <ion-row (click)="viewOrderDetails(order)">
                                    <ion-col>
                                        Narration: <ion-text color="secondary">
                                            {{order.narration}}</ion-text>
                                    </ion-col>
                                </ion-row>

                                <ion-row (click)="viewOrderDetails(order)">
                                    <ion-col>
                                        Order inputed by: <ion-text color="secondary">
                                            {{order.userIDName}}</ion-text>
                                    </ion-col>
                                </ion-row>

                                <ion-row (click)="viewOrderDetails(order)">
                                    <ion-col *ngIf="order.dataExportedUserIDName">
                                        Exported by: <ion-text color="secondary">
                                            {{order.dataExportedUserIDName}}</ion-text> on <ion-text color="secondary">
                                            {{order.dataExportedDateTime | date:'EE dd MMM yyyy, h:mm a'}}</ion-text>
                                    </ion-col>
                                    <ion-col *ngIf="!order.dataExportedUserIDName">
                                        Not exported
                                    </ion-col>
                                </ion-row>

                                <ion-item color="light" lines="none">
                                    <ion-label>Order status</ion-label>
                                    <ion-select [interfaceOptions]="customPopoverStatusOptions" interface="popover"
                                        [(ngModel)]="order.orderStatus" (ionChange)="orderStatusChanged(order)"
                                        placeholder="Select status">
                                        <!-- Cancelled orders cannot be changed. -->
                                        <ion-select-option *ngFor="let o of orderStatusInfo"
                                            [disabled]="isOrderStatusDisabled(o,order)" [value]="o.orderStatus">
                                            {{o.text}}</ion-select-option>
                                    </ion-select>
                                </ion-item>
                            </ion-card-content>
                        </ion-card>
                    </ng-container>
                </ng-container>
            </ng-container>
        </ion-item-group>
    </div>
</ion-content>